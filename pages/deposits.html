<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الإيداعات - Cicada</title>
    <meta name="description" content="إدارة الإيداعات في حسابك على منصة Cicada، إنشاء إيداع جديد ومراجعة سجل الإيداعات.">

    <!-- CSS -->
    <link rel="stylesheet" href="../styles/style.css">
    <link rel="stylesheet" href="../styles/dashboard.css">
    <link rel="stylesheet" href="../styles/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="../assets/icons/favicon.ico">
</head>
<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="../assets/images/logo.png" alt="Cicada Logo" class="sidebar-logo" onerror="this.style.display='none'">
                <h2 class="sidebar-brand">Cicada</h2>
            </div>

            <nav class="sidebar-menu">
                <div class="menu-category">الرئيسية</div>
                <a href="dashboard.html" class="menu-item">
                    <i class="fas fa-home"></i>
                    <span>لوحة التحكم</span>
                </a>
                <a href="tasks.html" class="menu-item">
                    <i class="fas fa-tasks"></i>
                    <span>المهام</span>
                </a>
                <a href="investments.html" class="menu-item">
                    <i class="fas fa-chart-line"></i>
                    <span>الاستثمارات</span>
                </a>

                <div class="menu-category">المعاملات</div>
                <a href="deposits.html" class="menu-item active">
                    <i class="fas fa-arrow-down"></i>
                    <span>الإيداعات</span>
                </a>
                <a href="withdrawals.html" class="menu-item">
                    <i class="fas fa-arrow-up"></i>
                    <span>السحوبات</span>
                </a>
                <a href="transactions.html" class="menu-item">
                    <i class="fas fa-receipt"></i>
                    <span>سجل المعاملات</span>
                </a>

                <div class="menu-category">الحساب</div>
                <a href="profile.html" class="menu-item">
                    <i class="fas fa-user"></i>
                    <span>الملف الشخصي</span>
                </a>
                <a href="referrals.html" class="menu-item">
                    <i class="fas fa-user-friends"></i>
                    <span>الإحالات</span>
                </a>
                <a href="kyc.html" class="menu-item">
                    <i class="fas fa-id-card"></i>
                    <span>التحقق (KYC)</span>
                </a>

                <div class="menu-category">الدعم والقانوني</div>
                <a href="support.html" class="menu-item">
                    <i class="fas fa-headset"></i>
                    <span>الدعم الفني</span>
                </a>
                <a href="terms.html" class="menu-item">
                    <i class="fas fa-file-contract"></i>
                    <span>الشروط والأحكام</span>
                </a>
                <a href="privacy.html" class="menu-item">
                    <i class="fas fa-user-shield"></i>
                    <span>سياسة الخصوصية</span>
                </a>
                <a href="blog.html" class="menu-item">
                    <i class="fas fa-blog"></i>
                    <span>المدونة</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="user-mini-profile">
                    <img src="../assets/images/avatar-placeholder.png" alt="User" class="user-avatar-sm" onerror="this.style.display='none'">
                    <div class="user-info-sm">
                        <h4 data-user="name">مستخدم</h4>
                        <p data-user="email">user@email.com</p>
                    </div>
                </div>
                <button class="menu-item" data-logout="true" style="margin-top:1rem; width:100%; justify-content:flex-start;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>تسجيل الخروج</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <header class="topbar">
                <div class="dashboard-title">
                    <button class="toggle-sidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div>
                        <h1>الإيداعات</h1>
                        <p>قم بإضافة إيداع جديد أو راجع سجل إيداعاتك</p>
                    </div>
                </div>
                <div class="topbar-actions">
                    <button class="action-btn" title="إشعارات">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">3</span>
                    </button>
                    <button class="action-btn" title="الملف الشخصي" onclick="window.location.href='profile.html'">
                        <i class="fas fa-user-circle"></i>
                    </button>
                </div>
            </header>

            <!-- Stats -->
            <section class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon wallet">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="stat-info">
                        <h3>إجمالي الإيداعات</h3>
                        <div class="stat-value" data-stat="total-deposits">$0.00</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon investment">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-info">
                        <h3>آخر إيداع</h3>
                        <div class="stat-value" data-stat="last-deposit">$0.00</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon tasks">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3>إيداعات قيد المعالجة</h3>
                        <div class="stat-value" data-stat="pending-deposits">0</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon referral">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="stat-info">
                        <h3>متوسط قيمة الإيداع</h3>
                        <div class="stat-value" data-stat="avg-deposit">$0.00</div>
                    </div>
                </div>
            </section>

            <!-- New Deposit Form -->
            <section class="card">
                <div class="card-header">
                    <h3>إنشاء إيداع جديد</h3>
                </div>
                <form id="depositForm">
                    <div class="form-group">
                        <label class="form-label" for="depositAmount">مبلغ الإيداع (بالدولار)</label>
                        <input 
                            type="number" 
                            id="depositAmount" 
                            name="amount" 
                            class="form-input" 
                            placeholder="مثال: 100" 
                            min="10" 
                            step="0.01"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="depositMethod">طريقة الدفع</label>
                        <select id="depositMethod" name="method" class="form-input" required>
                            <option value="">اختر طريقة الدفع</option>
                            <option value="card">بطاقة بنكية (Visa / MasterCard)</option>
                            <option value="paypal">PayPal</option>
                            <option value="crypto">عملة رقمية (USDT / BTC)</option>
                            <option value="bank">حوالة بنكية</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="depositPlan">الخطة الاستثمارية</label>
                        <select id="depositPlan" name="plan" class="form-input" required>
                            <option value="">اختر الخطة</option>
                            <option value="basic">الخطة الأساسية (1.5% يومياً)</option>
                            <option value="pro">الخطة الاحترافية (2.5% يومياً)</option>
                            <option value="enterprise">خطة المؤسسات (3.5% يومياً)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="depositNote">ملاحظات (اختياري)</label>
                        <textarea 
                            id="depositNote" 
                            name="note" 
                            class="form-input" 
                            rows="3" 
                            placeholder="أي ملاحظات إضافية عن الإيداع (اختياري)"
                        ></textarea>
                    </div>

                    <button type="submit" class="btn-primary" style="margin-top:1rem;">
                        <i class="fas fa-arrow-down"></i> تأكيد الإيداع
                    </button>
                </form>
            </section>

            <!-- Deposits History -->
            <section class="card">
                <div class="card-header">
                    <h3>سجل الإيداعات</h3>
                    <span style="color:var(--text-light); font-size:0.9rem;">آخر الإيداعات في حسابك</span>
                </div>
                <div class="table-responsive">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>المبلغ</th>
                                <th>الطريقة</th>
                                <th>الخطة</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody id="depositsTableBody">
                            <!-- يتم تعبئتها عبر JavaScript لاحقاً -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../scripts/main.js"></script>
    <script src="../scripts/auth.js"></script>
    <script src="../scripts/dashboard.js"></script>
    <!-- يمكن لاحقاً ربط الإيداعات بـ API عبر هذا الملف -->
    <script src="../scripts/api.js"></script>
    <script>
        // منطق بسيط مؤقت داخل الصفحة إلى أن نربطه بـ api.js

        const demoDeposits = [
            { date: '2025-12-25', amount: 250, method: 'بطاقة بنكية', plan: 'الخطة الأساسية', status: 'success' },
            { date: '2025-12-24', amount: 500, method: 'USDT', plan: 'الخطة الاحترافية', status: 'pending' },
            { date: '2025-12-20', amount: 1500, method: 'حوالة بنكية', plan: 'خطة المؤسسات', status: 'success' }
        ];

        function renderDepositsTable() {
            const tbody = document.getElementById('depositsTableBody');
            if (!tbody) return;

            if (demoDeposits.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align:center; color:var(--text-light); padding:1.5rem;">
                            لا توجد إيداعات مسجلة حتى الآن.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = demoDeposits.map(dep => `
                <tr>
                    <td>${dep.date}</td>
                    <td>$${dep.amount.toFixed(2)}</td>
                    <td>${dep.method}</td>
                    <td>${dep.plan}</td>
                    <td>
                        <span class="status-badge ${
                            dep.status === 'success' ? 'success' : dep.status === 'pending' ? 'pending' : 'failed'
                        }">
                            ${dep.status === 'success' ? 'مكتمل' : dep.status === 'pending' ? 'قيد المعالجة' : 'مرفوض'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function updateDepositStats() {
            const total = demoDeposits.reduce((sum, d) => sum + d.amount, 0);
            const pendingCount = demoDeposits.filter(d => d.status === 'pending').length;
            const last = demoDeposits[0]?.amount || 0;
            const avg = demoDeposits.length ? total / demoDeposits.length : 0;

            const totalEl = document.querySelector('[data-stat="total-deposits"]');
            const pendingEl = document.querySelector('[data-stat="pending-deposits"]');
            const lastEl = document.querySelector('[data-stat="last-deposit"]');
            const avgEl = document.querySelector('[data-stat="avg-deposit"]');

            if (totalEl) totalEl.textContent = `$${total.toFixed(2)}`;
            if (pendingEl) pendingEl.textContent = pendingCount.toString();
            if (lastEl) lastEl.textContent = `$${last.toFixed(2)}`;
            if (avgEl) avgEl.textContent = `$${avg.toFixed(2)}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            // حماية الصفحة + تهيئة الـ sidebar واليوزر من dashboard.js / auth.js
            if (window.CicadaAuth && window.CicadaAuth.protectPage) {
                window.CicadaAuth.protectPage();
            }
            if (typeof loadUserInfo === 'function') loadUserInfo();
            if (typeof initSidebarToggle === 'function') initSidebarToggle();
            if (typeof highlightActiveMenu === 'function') highlightActiveMenu();

            renderDepositsTable();
            updateDepositStats();

            const depositForm = document.getElementById('depositForm');
            if (depositForm) {
                depositForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const amount = parseFloat(document.getElementById('depositAmount').value || '0');
                    const method = document.getElementById('depositMethod').value;
                    const plan = document.getElementById('depositPlan').value;

                    if (!amount || amount < 10 || !method || !plan) {
                        if (window.CicadaAuth && window.CicadaAuth.showAuthAlert) {
                            window.CicadaAuth.showAuthAlert('warning', 'الرجاء إدخال جميع بيانات الإيداع بشكل صحيح (الحد الأدنى 10$).');
                        } else {
                            alert('الرجاء إدخال جميع بيانات الإيداع بشكل صحيح (الحد الأدنى 10$).');
                        }
                        return;
                    }

                    // هنا لاحقاً يتم استدعاء API حقيقي، حالياً نضيفه تجريبياً للقائمة
                    demoDeposits.unshift({
                        date: new Date().toISOString().slice(0, 10),
                        amount,
                        method,
                        plan,
                        status: 'pending'
                    });

                    renderDepositsTable();
                    updateDepositStats();
                    depositForm.reset();

                    if (window.CicadaAuth && window.CicadaAuth.showAuthAlert) {
                        window.CicadaAuth.showAuthAlert('success', 'تم استلام طلب الإيداع بنجاح! سيتم مراجعته خلال وقت قصير.');
                    } else {
                        alert('تم استلام طلب الإيداع بنجاح!');
                    }
                });
            }
        });
    </script>
</body>
</html>
